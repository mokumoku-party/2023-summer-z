<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/ball.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.2/dist/alpine.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
  <title>Hanabishi</title>
</head>

<body x-data="ball()" x-init="initSortable(); console.log('test');">
  <header>
    <h1>H A N A B I S H I</h1>
  </header>
  <div class="content">
    <div class="selected-star">
      <h2>ほし</h2>
      <div class="star-list" x-ref="starList">
        <template x-for="(star, index) in stars" :key="index">
          <div class="star-container" :data-id="index" draggable="true">
            <div class="star" :style="`background-color: ${getHsl(star.colorId)}`">
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <script>
    // テスト用
    // 星の選択情報を登録しておく
    const starInfo = [
      {
        type: '菊',
        colorId: 0,
      },
      {
        type: '菊',
        colorId: 5,
      },
      {
        type: '牡丹',
        colorId: 2,
      },
    ];

    window.onload = async () => {
      // テスト用
      localStorage.setItem('star', JSON.stringify(starInfo));
    }

    const ball = () => {
      return {
        stars: starInfo,
        colors: {
          beni: [16, 100, 100],
          purple: [271, 80, 88],
          orange: [38, 100, 100],
          light_green: [90, 100, 100],
          red: [0, 100, 100],
          blue: [240, 100, 100],
          green: [120, 100, 100],
          yellow: [60, 100, 100]
        },
        getHsl(id) {
          const color = Object.values(this.colors)[id];
          // h（Hue）は0~360の範囲でそのまま使用
          const h = color[0] % 360;

          // s（Saturation）とb（Brightness）は0~100の範囲に正規化
          const s = color[1] / 100.0;
          const b = color[2] / 100.0;

          // L（Lightness）の値を計算
          const L = (2 - s) * b / 2;

          let S;
          if (L < 1) {
            S = s * b / (L < 0.5 ? L * 2 : 2 - L * 2);
          } else {
            S = 0;
          }

          // LとSを0~100の範囲に変換
          const L100 = L * 100;
          const S100 = S * 100;

          // HSL文字列を返す
          return `hsl(${h}, ${S100}%, ${L100}%)`;
        },
        initSortable() {
          console.log('initSortable');
          const self = this;
          const el = this.$refs.starList;
          Sortable.create(el, {
            animation: 150,
            onEnd: (event) => {
              console.log('onEnd');
              const item = self.stars.splice(event.oldIndex, 1)[0];
              self.stars.splice(event.newIndex, 0, item);

              // データが変更されたことをAlpineJSに明示的に通知
              self.stars = [...self.stars];
              console.dir(this.stars);
            }
          });
        },
      }
    }
  </script>
</body>

</html>